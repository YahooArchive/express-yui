/*
 * Copyright (c) 2013, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 */

/*jslint node:true, nomen: true */

/**
Patches `Y.Loader` to support `templates` requirements, which enables you to
require templates easily without having to know the name of the module
generated by the build transpiler/plugin/task while define modules.

You can write your modules like this:

    YUI.add('name', function (Y) {
        // module code...
    }, '0.1', { requires: [], templates: ['foo'] });

And you can enable the patch like this:

    app.yui.patch(require('express-yui/lib/patches/templates-bundles-requires'));

This will guarantee, that the template denotated by the logical name `foo`
will be loaded. Of course, it will be loaded based on the transpiler
output, which generates a more complex module name. If you don't use this patch, you will
have to use the full name of the generated module.

@module express-yui/lib/patches/templates-bundles-requires
**/
module.exports = function (Y) {
    var getRequires = Y.Env._loader.getRequires;
    Y.Env._loader.getRequires = function (mod) {
        var i, m;
        if (!mod) {
            return [];
        }
        if (mod._parsed) {
            return mod.expanded || [];
        }
        mod.requires = mod.requires || [];
        // expanding requirements with templates
        if (mod.templates) {
            for (i = 0; i < mod.templates.length; i += 1) {
                m = this.getModule(mod.group + '-template-' + mod.templates[i]);
                if (m) {
                    mod.requires.push(m.name);
                }
            }
        }
        return getRequires.apply(this, arguments);
    };
};
